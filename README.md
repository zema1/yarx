<div align="center">
  <a href="https://github.com/othneildrew/Best-README-Template">
    <img src="data:image/png;base64,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" alt="Logo" width="201" height="150">
</a>
  <p align="center">
    An awesome reverse engine for xray yaml poc.
  </p>
</div>


## Yarx 是什么

Yarx 来自于 `x-r-a-y` 的反向拼写，它能够根据 xray 的 yaml poc 规则全自动的生成一个满足规则要求的 Server，使用 xray 扫描该 Server 将会扫描出对应的漏洞。它的核心工作原理如下：



![yarx-core](./.github/images/core.svg)



它的主要特性有:

+ 支持 status、header、body 等位置的响应变换
+ 支持 `==` `contains` `submatch` 等各种匹配模式
+ 支持动态变量的渲染和捕获以及多级规则的变量追踪
+ 支持绝大部分内置函数的解析和调用
+ 通过路由合并和智能排序等策略有效减少路由冲突
+ 平铺式规则处理逻辑，支持并发扫描
+ 支持捕获扫描事件做进一步分析联动

加载 xray 仓库 poc 并使用 xray 1.8.2 版本扫描结果如下：

![5.gif](https://i.loli.net/2021/11/15/1QwqCjAr9v3YiZb.gif)

## 使用场景

+ 作为**蜜罐**服务，精准探测 xray 的扫描态势
+ 作为**反制**服务，有效干扰 xray 正常的漏洞扫描
+ 作为**测试**服务，检测 xray 的运行是否正常

## 安装

建议直接从 [Release](https://github.com/zema1/yarx/releases) 中下载对应平台二进制文件，解压后在命令行直接使用无需安装。

如果需要自行构建，clone 仓库进入目录并运行编译命令即可在目录中生成一个二进制文件。

```bash
 GO111MODULE=on go build ./cmd/yarx/
```
## 用法

```bash
USAGE:
   ./yarx [global options] [arguments...]

GLOBAL OPTIONS:
   --pocs value, -p value    load pocs from this dir
   --listen value, -l value  the http server listen address (default: "127.0.0.1:7788")

   --verbose, -V             verbose mode, which is  equivalent to --log-level debug (default: false)
   --help, -h                show help (default: false)
```

Yarx 的使用非常简单，你只需指定一个包含 yaml poc 的文件夹并指定一个 http 服务的监听地址，Yarx 就会自动的加载文件夹中所有的 poc 规则并绑定到 server 的处理函数中。

```bash
# 创建一个 8080 端口的 http server 模拟 pocs 文件夹中的所有漏洞
./yarx -p ./pocs -l 0.0.0.0:8080
```
![running](./.github/images/running.png)

你可以使用本仓库的 [pocs](./pocs) 文件夹，也可以直接使用 xray 官方仓库的 [https://github.com/chaitin/xray/tree/master/pocs](https://github.com/chaitin/xray/tree/master/pocs) 文件夹。本仓库仅仅是去掉了暂时不支持的 poc，后者除了在运行时会打印一点错误信息之外没有任何区别，我会定期同步数据来增加更多 poc。当然，你也可以指定自己编写的 poc。

## 开发

Yarx 也可以作为 go 的 package 来使用

```go
yr := &yarx.Yarx{}
// err := yr.Parse([]byte("poc-data"))
err := yr.ParseFile("/path/to/a/yaml/poc")
if err != nil {
    panic(err)
}

// 每个成功加载的 poc 对应一个 MutationChain
// poc 中的 rule 则对应于 MutationRule
chains := yr.Chains()
rules := yr.Rules()
...

// 一键生成上述规则的 http handler
handler := yr.HTTPHandler()

// 事件处理
handler.OnRuleMatch(func(e *yarx.ScanEvent) {
})
handler.OnPocMatch(func(e *yarx.ScanEvent) {
    fmt.Println(e.RemoteAddr)
    fmt.Println(e.Request)
    fmt.Println(e.Response)
    fmt.Println(e.PocMatched)
    fmt.Println(e.RuleMatched)
})

// 启动服务
http.ListenAndServe(handler, "127.0.0.1:7788")
```

## 错误说明

Yarx 在解析 poc 的过程中可能会出现错误，这些 poc 不会被加载到最终的 http 服务中，遇到错误时不要惊慌，基本都是这几类问题：

+ 不支持路径本身太灵活的

  主要是 `{{name}}.php` 和 `/` 之类的路径，这些路径作为路由时无法与其他类似的规则区分开，目测无解（相信我，Yarx 已经尽了最大努力避免路有冲突）

+ 不支持 `set` 定义中存在复杂转换的情况，如：

  ```yaml
  set:
    r0: randLowercase(8)
    r1: base64(r0) # 追踪这个变量太复杂，不打算支持
  ```
  
+ 不支持使用反连平台的，即 yaml 中有 `newReverse()` 调用的，后续有计划支持

如果你遇到其他类型的报错，可以提交一个 issue，带上报错的 yaml poc 即可，我会尽快处理。

## 规划

[x] 支持依赖反连平台的 POC

[x] 支持依赖 request 的 POC

## 更新日志

* 0.1
    * 第一版发布

